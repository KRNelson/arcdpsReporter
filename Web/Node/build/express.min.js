"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&("get"in s?t.__esModule:!s.writable&&!s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,s)}:function(e,t,r,a){e[a=void 0===a?r:a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,n,i,_){return new(i=i||Promise)(function(r,t){function a(e){try{o(_.next(e))}catch(e){t(e)}}function s(e){try{o(_.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(a,s)}o((_=_.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.server=void 0;const express_1=__importDefault(require("express")),mysql2_1=require("mysql2"),express_fileupload_1=__importDefault(require("express-fileupload")),cors_1=__importDefault(require("cors")),fs_extra_1=__importDefault(require("fs-extra")),body_parser_1=__importDefault(require("body-parser")),morgan_1=__importDefault(require("morgan")),node_process_1=require("node:process"),path_1=__importDefault(require("path")),uuid_1=require("uuid"),https_1=__importDefault(require("https")),k8s=__importStar(require("@kubernetes/client-node")),app=(0,express_1.default)(),port=3e3,sport=3443,kc=new k8s.KubeConfig,k8sApi=(kc.loadFromDefault(),kc.makeApiClient(k8s.CoreV1Api)),fncdbconnection=(app.use((0,express_fileupload_1.default)({createParentPath:!0})),app.use((0,cors_1.default)()),app.use(body_parser_1.default.json()),app.use(body_parser_1.default.urlencoded({extended:!0})),app.use((0,morgan_1.default)("dev")),app.get("/",(e,t)=>{t.send("TypeScript With Express")}),app.get("/test",(e,t)=>{t.send("Successful test!")}),()=>{try{var t=node_process_1.env.MYSQL_USER_FILE,e=node_process_1.env.MYSQL_PASSWORD_FILE,r=path_1.default.resolve(t),a=path_1.default.resolve(e),s={host:"localhost",port:3306,user:fs_extra_1.default.readFileSync(r,"utf8").replace("\n",""),password:fs_extra_1.default.readFileSync(a,"utf8").replace("\n",""),database:"web",insecureAuth:!0,connectionLimit:5};return(0,mysql2_1.createPool)(s)}catch(e){t={host:"localhost",port:3306,user:"user",password:"password",database:"web",insecureAuth:!0,connectionLimit:5};return(0,mysql2_1.createPool)(t)}});var dbconnection=fncdbconnection();dbconnection.on("connection",function(e){console.log("DB Connection established"),e.on("error",function(e){console.error(new Date,"MySQL error",e.code)}),e.on("close",function(e){console.error(new Date,"MySQL close",e)})});const dbquery=(t,a,s,o,n,e,i)=>{e.getConnection(function(e,r){e?i(e):(r.execute(t,a,(e,t)=>{r.release(),e?o(e):s(t)}),r.on("error",e=>{n(e)}))})},myquery=(e,t,r)=>{dbquery(e,t,r,e=>{console.log(e)},e=>{console.log(e)},dbconnection,e=>{console.log(e)})},_player=e=>({account:e.LOG_ACC_NA}),_mechanics=(app.get("/players",(e,t)=>{myquery("CALL web.getAllPlayers()",[],e=>{e=e[0];t.send({status:!0,data:e.map(e=>_player(e))})})}),app.post("/players",(e,t)=>{e={logs:(e=e.body.id||[],(Array.isArray(e)?e:[e]).map(e=>({id:e})))};myquery("CALL web.postPlayers(?)",[JSON.stringify(e)],e=>{e=e[0];t.send({status:!0,data:e.map(e=>_player(e))})})}),e=>({identifier:e.LOG_SYS_NR,fight:e.LOG_FGT_NA,fight_icon:e.LOG_FGT_IC,start:e.LOG_STR_DT,account:e.LOG_ACC_NA,character:e.LOG_CHR_NA,profession:e.LOG_PRO_NA,mechanic:e.LOG_MCH_NA,description:e.LOG_DSC_TE,total:Number(e.TOT_NR)})),_rotations=(app.get("/mechanics",(e,t)=>{myquery("CALL web.getMechanics()",[],e=>{e=e[0];t.send({status:!0,data:e.map(e=>_mechanics(e))})})}),app.post("/mechanics",(e,t)=>{e={logs:(e=e.body.id||[],(Array.isArray(e)?e:[e]).map(e=>({id:e})))};myquery("CALL web.postMechanics(?)",[JSON.stringify(e)],e=>{e=e[0];t.send({status:!0,data:e.map(e=>_mechanics(e))})})}),e=>({identifier:e.LOG_SYS_NR,fight:e.LOG_FGT_NA,fight_icon:e.LOG_FGT_IC,start:e.LOG_STR_DT,account:e.LOG_ACC_NA,character:e.LOG_CHR_NA,profession:e.LOG_PRO_NA,skill_id:e.LOG_SKL_ID,cast:Number(e.LOG_CST_NR),duration:Number(e.LOG_DUR_NR)})),_log=(app.get("/rotations",(e,t)=>{myquery("CALL web.getRotations()",[],e=>{e=e[0];t.send({status:!0,data:e.map(e=>_rotations(e))})})}),app.post("/rotations",(e,t)=>{e={logs:(e=e.body.id||[],(Array.isArray(e)?e:[e]).map(e=>({id:e})))};myquery("CALL web.postRotations(?)",[JSON.stringify(e)],e=>{e=e[0];t.send({status:!0,data:e.map(e=>_rotations(e))})})}),e=>({identifier:e.LOG_SYS_NR,elite_version:e.LOG_ELI_VER,trigger_id:Number(e.LOG_TRG_ID),ei_encounter_id:Number(e.LOG_EI_ID),fight:e.LOG_FGT_NA,fight_icon:e.LOG_FGT_IC,arc_version:e.LOG_ARC_VER,gw2_version:e.LOG_GW_VER,language:e.LOG_LANG_TE,language_nr:Number(e.LOG_LANG_NR),recorded_by:e.LOG_REC_TE,start:e.LOG_STR_DT,end:e.LOG_END_DT,duration:e.LOG_DUR_DT,duration_ms:Number(e.LOG_DUR_MS),log_start_offset:Number(e.LOG_STR_OFF),is_win:1==e.LOG_SUC_IR,is_cm:1==e.LOG_CM_IR})),privateKey=(app.get("/logs",(e,t)=>{myquery("CALL web.getLogs()",[],e=>{e=e[0];t.send({status:!0,data:e.map(e=>_log(e))})})}),app.post("/upload",(s,o)=>__awaiter(void 0,void 0,void 0,function*(){try{if(s.files){var e=[],e=Array.isArray(s.files.logs)?s.files.logs:[s.files.logs];const a=(0,uuid_1.v4)();e.forEach((e,t,r)=>{e.mv(`/etc/logs/${a}/`+e.name)});var t=kc.makeApiClient(k8s.BatchV1Api),r={metadata:{name:"job-parse-"+a,labels:{app:"job-"+a}},spec:{template:{spec:{containers:[{name:"parser",image:"venerablenelson/projects:parser",imagePullPolicy:"Always",command:["wine","/GuildWars2EliteInsights.exe","-p","-c","/report.conf"].concat(e.map(e=>`/etc/logs/${a}/`+e.name)),volumeMounts:[{name:"logs",mountPath:"/etc/logs"}]}],volumes:[{name:"logs",persistentVolumeClaim:{claimName:"logs-pvc"}}],restartPolicy:"Never",imagePullSecrets:[{name:"venerablenelson"}]}},ttlSecondsAfterFinished:1,backoffLimit:1}};t.createNamespacedJob("default",r).then(e=>{var t=new k8s.KubeConfig;t.loadFromDefault(),new k8s.Watch(t).watch("/apis/batch/v1/jobs",{},(e,t,r)=>{console.log("WATCHING",e,JSON.stringify(t),JSON.stringify(r))},e=>{console.log("ERROR!!!",JSON.stringify(e),e),o.status(500).send("Error")}).then(e=>{console.log("?!?!?!?!",JSON.stringify(e))})}).catch(e=>{o.status(500).send("Error")})}else o.send({status:!1,message:"No file uploaded"})}catch(e){o.status(500).send(e)}})),app.get("/reprocess",(e,t)=>{k8sApi.listNamespacedPod("default").then(e=>{e=e.body.items.filter(e=>{try{return"venerable-report"===e.metadata.labels.app}catch(e){return!1}}).map(e=>e.metadata.name);console.log("POD!!!",e),new k8s.Exec(kc).exec("default",e,"database",["./reprocess.sh"],process.stdout,process.stderr,process.stdin,!0,e=>t.send(JSON.stringify(e,null,2)))}).catch(e=>{console.log("CATCH?",e),t.send(e)})}),fs_extra_1.default.readFileSync(__dirname+"/../server.key","utf8")),certificate=fs_extra_1.default.readFileSync(__dirname+"/../server.crt","utf8");exports.server=https_1.default.createServer({key:privateKey,cert:certificate},app).listen(sport,()=>{console.log("Express server listening to port "+sport)}),exports.default=app;